<?php/**	* News Controller class	* PHP versions 5.3.5	* @date 28-Dec-2011	* @Purpose:This controller handles all the functionalities regarding news management.	* @filesource	* @author  Netset Solutions	* @revision	* @version 1.3.12**/App::import('Sanitize');class NewsController extends AppController{    var $name       	=  "News";	    /**	* Specifies helpers classes used in the view pages	* @access public    */	    var $helpers    	=  array('Html', 'Form', 'Javascript', 'Session','General');	    /**	* Specifies components classes used	* @access public    */	    var $components 	=  array('RequestHandler','Common','Upload');    var $paginate		=  array();        var $uses       	=  array('News'); // For Default Model	/******************************* START FUNCTIONS **************************/	#_________________________________________________________________________#    /**    * @Date: 28-Dec-2011    * @Method : beforeFilter    * @Purpose: This function is called before any other function.    * @Param: none    * @Return: none     **/    function beforeFilter(){ // This  function is called first before parsing this controller file		//$this->checkUserSession(); // Checking valid Session.		$this->set('common',$this->Common);    $this->layout = 'layout_admin';		    }    #_________________________________________________________________________#    /**    * @Date: 28-Dec-2011    * @Method : index    * @Purpose: This function is the default function of the controller    * @Param: none    * @Return: none     **/	function index() {		$this->render('login');		if($this->Session->read("SESSION_USER") != ""){			$this->redirect('dashboard');		}    }		#_________________________________________________________________________#    /**    * @Date: 28-Dec-2011    * @Method : admin_list    * @Purpose: This function is to show list of Clients in system.    * @Param: none    * @Return: none     **/ function admin_list(){      $this->set('title_for_layout','News Listing');            $this->set("pageTitle","News Listing");                   $this->set("search1", "");                                       $this->set("search2", "");                                       $criteria = "1"; //All Searching	  $this->Session->delete('SESSION_SEARCH');	      // Delete user and its licences and orders(single/multiple)            if(isset($this->params['form']['delete']) || isset($this->params['pass'][0]) == "delete"){                                                            if(isset($this->params['form']['IDs'])){                                 $deleteString = implode("','",$this->params['form']['IDs']);            }elseif(isset($this->params['pass'][1])){                                 $deleteString = $this->params['pass'][1];                               }            if(!empty($deleteString)){              $this->News->deleteAll("News.id in ('".$deleteString."')");        $this->Session->setFlash("<div class='success-message flash notice'>News(s) deleted successfully.</div>", 'layout_success');		$this->redirect('list');                                                        }            }                                          if(isset($this->data['News']) || !empty($this->params['named'])) {            if(!empty($this->data['News']['fieldName']) || isset($this->params['named']['field'])){                                                                         if(trim(isset($this->data['News']['fieldName'])) != ""){                        $search1 = trim($this->data['News']['fieldName']);                              }elseif(isset($this->params['named']['field'])){                                      $search1 = trim($this->params['named']['field']);                                     }                $this->set("search1",$search1);                                                     }            if(isset($this->data['News']['value1']) || isset($this->data['News']['value2']) || isset($this->params['named']['value'])){                        if(isset($this->data['News']['value1']) || isset($this->data['News']['value2'])){                                                                  $search2 = ($this->data['News']['fieldName'] != "News.status")?trim($this->data['News']['value1']):$this->data['News']['value2'];            }elseif(isset($this->params['named']['value'])){             $search2 = trim($this->params['named']['value']);            }                                                            $this->set("search2",$search2);                              }            /* Searching starts from here */                                                     if(!empty($search1) && (!empty($search2) || $search1 == "News.status")){                                                                                 $criteria = $search1." LIKE '%".Sanitize::escape($search2)."%'";       $this->Session->write('SESSION_SEARCH', $criteria);      }else{            $this->set("search1","");            $this->set("search2","");            }            }            if(isset($this->params['named'])){                $urlString = "/";                                 $completeUrl  = array();                    if(!empty($this->params['named']['page']))                $completeUrl['page'] = $this->params['named']['page'];                    if(!empty($this->params['named']['sort']))                            $completeUrl['sort'] = $this->params['named']['sort'];                    if(!empty($this->params['named']['direction']))                       $completeUrl['direction'] = $this->params['named']['direction'];                    if(!empty($search1))                                                  $completeUrl['field'] = $search1;                    if(isset($search2))                                                   $completeUrl['value'] = $search2;                    foreach($completeUrl as $key=>$value){                                $urlString.= $key.":".$value."/";                                     }      }            $this->set('urlString',$urlString);            if(isset($this->params['form']['publish'])){            $setValue = array('status' => "'1'");                   $messageStr = "Selected News(s) have been activated.";                    }elseif(isset($this->params['form']['unpublish'])){      $setValue = array('status' => "'0'");                   $messageStr = "Selected News(s) have been deactivated.";                  }                                                                   if(!empty($setValue)){                                  if(isset($this->params['form']['IDs'])){                $saveString = implode("','",$this->params['form']['IDs']);            }            if($saveString != ""){                                                $this->News->updateAll($setValue,"News.id in ('".$saveString."')");                                                                       $this->Session->setFlash($messageStr, 'layout_success');                                }            }            $this->paginate = array(                                              'fields' => array(                                                    'id',            'type',            'title', 	  'created',		'published',      'description',      'status',            'modified'                 ),            'page'=> 1,'limit' => 10,            'order' => array('id' => 'desc')            );            $data = $this->paginate('News',$criteria);            $this->set('resultData', $data);	}                                 		#_________________________________________________________________________#    /**    * @Date: 21-Aug-2011    * @Method : admin_add    * @Purpose: This function is to add/edit credentals from admin section.    * @Param: $id    * @Return: none     * @Return: none     **/  	function  admin_delete($id) {    if ($this->News->delete($id)) {    $this->Session->setFlash('The News with id: ' . $id . ' has been deleted.');    $this->redirect(array('action' => 'list'));    }    }	function admin_add($id = null) {		if(!empty($id) || !empty($this->data['News']['id'])){		    $this->set('title_for_layout','Edit News');			$this->pageTitle = "Edit News";			$this->set("pageTitle","Edit News");			$mode = "edit";		}else{		    $this->set('title_for_layout','Add News');			$this->pageTitle = "Add News";			$this->set("pageTitle","Add News");			$mode = "add";		}		if($this->data){				//$this->data['News']['published_on'] = date('Y/m/d h:i:s', strtotime($this->data['News']['published']));			if($mode == "edit" && $this->data['News']['image']['size']<=0){				//$this->News->unvalidate(array("image"));				unset($this->data['News']['image']);			 }           			$this->News->set($this->data['News']);		$isValidated=$this->News->validates();		 if($isValidated){		//print_r($this->data);exit;				if(!empty($this->data['News']['image']) && $this->data['News']['image']['size']>0){					$destination=realpath('../../app/webroot/img/news') . DS;					$file= $this->data['News']['image'];					$small=explode(".",$file['name']);				    $small=$small['0']."-small.".$small['1']; 					//$large=explode(".",$file['name']);				   // $large=$large['0']."-large.".$large['1']; 				    $criteria=array(							  'conditions'=>array('News.id'=>$this->data['News']['id']),							  'fields'=>array("News.image")							  );					$image=$this->News->find("first",$criteria);										@unlink($destination.$image['News']['image']); //Remove the existing image								$result1 = $this->Upload->upload($file, $destination,  $small, array('type'=>'resize','size'=>'240'));					//	$result2 = $this->Upload->upload($file, $destination,  $large, array('type'=>'resize','size'=>'350'));						$result = $this->Upload->upload($file, $destination, $file['name']);						$this->data['News']['image'] = $this->data['News']['image']['name'];											}				else{					unset($this->data['News']['image']);				}							      $data=$this->data['News'];//post				   $this->News->saveAll($this->data['News'], array('validate'=>false));					if($mode == "add"){						$this->Session->setFlash("<div class='success-message flash notice'>News has been created successfully.</div>");					}else{						$this->Session->setFlash("<div class='success-message flash notice'>News has been updated successfully.</div>");					}				  $this->redirect('list');			}else{				$this->set("Error",$this->News->invalidFields());			}		}else if(!empty($id)){			$this->data = $this->News->find('first', array('conditions'=>array('id'=>Sanitize::escape($id))));				if(!$this->data){				$this->redirect(array('action' => 'list'));			}		}	}		}